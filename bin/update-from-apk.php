#!/usr/bin/env php
<?php
/**
 * Add a new release to a game data JSON file, from an .apk.
 *
 * Usage:
 * $ update-from-apk.php <apk> <urlBase?>
 */

if ($argc < 2) {
    fwrite(STDERR, "Error: apk file missing\n");
    fwrite(STDERR, "Usage: update-from-apk.php <apk> [urlBasePath]\n");
    exit(1);
}
array_shift($argv);

$cmd = __DIR__ . '/create-from-apk.php';
foreach ($argv as $param) {
    $cmd .= ' ' . escapeshellarg($param);
}

exec($cmd, $output, $retval);

if ($retval != 0) {
    exit($retval);
}

$newData = json_decode(implode("\n", $output));
if ($newData === false) {
    fwrite(STDERR, "Error: Cannot parse JSON generated by create-from-apk.php\n");
    exit(2);
}

$packageName = $newData->packageName;

$gameFile = null;
$candidates = [
    realpath(__DIR__ . '/../gamestick') . '/' . $packageName . '.json',
    realpath(__DIR__ . '/../new') . '/' . $packageName . '.json',
];
foreach ($candidates as $jsonfile) {
    if (file_exists($jsonfile)) {
        $gameFile = $jsonfile;
        echo "Found game data file: $gameFile\n";
        break;
    }
}
if ($gameFile === null) {
    fwrite(STDERR, 'Error: File not found for game: ' . $packageName . "\n");
    exit(0);
}

$newRelease = $newData->releases[0];
$gameData = json_decode(file_get_contents($gameFile));

foreach ($gameData->releases as $release) {
    if ($release->versionCode == $newRelease->versionCode
        || $release->name == $newRelease->name
    ) {
        fwrite(
            STDERR,
            'Error: Release exists already: ' . $release->name
                . ' / ' . $release->versionCode . "\n"
        );
        exit(10);
    }
}

array_unshift($gameData->releases, $newRelease);

$json = json_encode($gameData, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE)
    . "\n";
file_put_contents($gameFile, $json);
echo 'Updated release in ' . $gameFile . "\n";
